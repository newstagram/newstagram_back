name: CD Pipeline

on:
  push:
    branches:
      - release

permissions:
  contents: read

env:
  AWS_REGION: ap-northeast-2 # AWS 리전 (서울)
  ECR_REPOSITORY_RSS: newstagram/rss-collector # ECR 리포지토리 이름 (RSS)
  ECR_REPOSITORY_API: newstagram/api-server # ECR 리포지토리 이름 (API)
  ECR_REPOSITORY_LOG: newstagram/logging-server # ECR 리포지토리 이름 (Logging)

jobs:
  # 1. CI: 빌드 및 테스트 (공통)
  ci:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          java-version: "17"
          distribution: "temurin"

      - name: Grant execute permission for gradlew
        run: chmod +x gradlew

      - name: Build with Gradle
        run: ./gradlew build -x test # 테스트는 생략하거나 필요시 포함

  # 2. CD: RSS Collector 배포
  deploy-rss-collector:
    needs: ci
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          java-version: "17"
          distribution: "temurin"

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Login to Amazon ECR
        id: login-ecr
        uses: aws-actions/amazon-ecr-login@v2

      - name: Build and Push Docker Image
        env:
          ECR_REGISTRY: ${{ steps.login-ecr.outputs.registry }}
          IMAGE_TAG: ${{ github.sha }}
        run: |
          # RSS Collector 빌드 (bootJar)
          chmod +x gradlew
          ./gradlew :rss-collector:bootJar -x test

          # Docker Image 빌드 및 푸시
          docker build -t $ECR_REGISTRY/$ECR_REPOSITORY_RSS:latest -f rss-collector/Dockerfile .
          docker push $ECR_REGISTRY/$ECR_REPOSITORY_RSS:latest

      - name: Deploy to EC2 (RSS Collector)
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.EC2_HOST_RSS }}
          username: ec2-user
          key: ${{ secrets.EC2_SSH_KEY }}
          script: |
            # AWS ECR 로그인
            aws ecr get-login-password --region ${{ env.AWS_REGION }} | docker login --username AWS --password-stdin ${{ steps.login-ecr.outputs.registry }}

            # 1. 현재 실행 중인 컨테이너 이미지 ID 저장 (롤백용)
            CURRENT_IMAGE_ID=$(docker inspect --format='{{.Image}}' rss-collector 2>/dev/null || true)
            echo "Current Image ID: $CURRENT_IMAGE_ID"

            # 2. 새 이미지 Pull
            docker pull ${{ steps.login-ecr.outputs.registry }}/${{ env.ECR_REPOSITORY_RSS }}:latest

            # 3. 기존 컨테이너 중지 및 삭제
            docker stop rss-collector || true
            docker rm rss-collector || true

            # 로그 디렉토리 생성
            mkdir -p /home/ec2-user/logs/rss-collector

            # 4. 새 컨테이너 실행
            echo "Starting new container..."
            docker run -d --name rss-collector \
              -e TZ=Asia/Seoul \
              -p 8082:8082 \
              -v /home/ec2-user/logs/rss-collector:/var/log/newstagram \
              -e LOGGING_FILE_NAME=/var/log/newstagram/application.log \
              -e SPRING_PROFILES_ACTIVE=prod \
              -e RDS_ENDPOINT="${{ secrets.RDS_ENDPOINT }}" \
              -e RDS_USERNAME="${{ secrets.RDS_USERNAME }}" \
              -e RDS_PASSWORD="${{ secrets.RDS_PASSWORD }}" \
              -e REDIS_HOST="${{ secrets.REDIS_HOST }}" \
              -e REDIS_PORT="${{ secrets.REDIS_PORT }}" \
              -e KAFKA_BOOTSTRAP_SERVERS="${{ secrets.KAFKA_BOOTSTRAP_SERVERS }}" \
              -e KAFKA_API_KEY="${{ secrets.KAFKA_API_KEY }}" \
              -e KAFKA_API_SECRET="${{ secrets.KAFKA_API_SECRET }}" \
              -e GMS_SECRET="${{ secrets.GMS_SECRET }}" \
              -e GMS_BASE_URL="${{ secrets.GMS_BASE_URL }}" \
              ${{ steps.login-ecr.outputs.registry }}/${{ env.ECR_REPOSITORY_RSS }}:latest

            # 5. 헬스 체크 및 롤백
            echo "Health checking..."
            sleep 15
            if [ -z "$(docker ps -q -f name=rss-collector)" ]; then
              echo "Deployment failed! Container is not running."
              docker logs rss-collector
              
              echo "Rolling back to previous version..."
              docker rm rss-collector || true
              
              if [ -n "$CURRENT_IMAGE_ID" ]; then
                docker run -d --name rss-collector \
                  -e TZ=Asia/Seoul \
                  -p 8082:8082 \
                  -v /home/ec2-user/logs/rss-collector:/var/log/newstagram \
                  -e LOGGING_FILE_NAME=/var/log/newstagram/application.log \
                  -e SPRING_PROFILES_ACTIVE=prod \
                  -e RDS_ENDPOINT="${{ secrets.RDS_ENDPOINT }}" \
                  -e RDS_USERNAME="${{ secrets.RDS_USERNAME }}" \
                  -e RDS_PASSWORD="${{ secrets.RDS_PASSWORD }}" \
                  -e REDIS_HOST="${{ secrets.REDIS_HOST }}" \
                  -e REDIS_PORT="${{ secrets.REDIS_PORT }}" \
                  -e KAFKA_BOOTSTRAP_SERVERS="${{ secrets.KAFKA_BOOTSTRAP_SERVERS }}" \
                  -e KAFKA_API_KEY="${{ secrets.KAFKA_API_KEY }}" \
                  -e KAFKA_API_SECRET="${{ secrets.KAFKA_API_SECRET }}" \
                  -e GMS_SECRET="${{ secrets.GMS_SECRET }}" \
                  -e GMS_BASE_URL="${{ secrets.GMS_BASE_URL }}" \
                  $CURRENT_IMAGE_ID
                echo "Rollback successful."
              else
                echo "No previous image found. Cannot rollback."
              fi
              exit 1
            else
              echo "Deployment successful."
              # 6. 미사용 이미지 정리 (Dangling images)
              docker image prune -f
            fi

  # 3. CD: API Server 배포
  deploy-api-server:
    needs: ci
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          java-version: "17"
          distribution: "temurin"

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Login to Amazon ECR
        id: login-ecr
        uses: aws-actions/amazon-ecr-login@v2

      - name: Build and Push Docker Image
        env:
          ECR_REGISTRY: ${{ steps.login-ecr.outputs.registry }}
          IMAGE_TAG: ${{ github.sha }}
        run: |
          chmod +x gradlew
          ./gradlew :api-server:bootJar -x test
          docker build -t $ECR_REGISTRY/$ECR_REPOSITORY_API:latest -f api-server/Dockerfile .
          docker push $ECR_REGISTRY/$ECR_REPOSITORY_API:latest

      - name: Deploy to EC2 (API Server)
        uses: appleboy/ssh-action@v1.0.3
        env:
          RDS_ENDPOINT: ${{ secrets.RDS_ENDPOINT }}
          RDS_USERNAME: ${{ secrets.RDS_USERNAME }}
          RDS_PASSWORD: ${{ secrets.RDS_PASSWORD }}
          REDIS_HOST: ${{ secrets.REDIS_HOST }}
          REDIS_PORT: ${{ secrets.REDIS_PORT }}
          KAFKA_BOOTSTRAP_SERVERS: ${{ secrets.KAFKA_BOOTSTRAP_SERVERS }}
          KAFKA_API_KEY: ${{ secrets.KAFKA_API_KEY }}
          KAFKA_API_SECRET: ${{ secrets.KAFKA_API_SECRET }}
          JWT_SECRET: ${{ secrets.JWT_SECRET }}
          GMS_SECRET: ${{ secrets.GMS_SECRET }}
          GMS_BASE_URL: ${{ secrets.GMS_BASE_URL }}
          GOOGLE_CLIENT_ID: ${{ secrets.GOOGLE_CLIENT_ID }}
          GOOGLE_CLIENT_SECRET: ${{ secrets.GOOGLE_CLIENT_SECRET }}
          GOOGLE_REDIRECT_URI: ${{ secrets.GOOGLE_REDIRECT_URI }}
          GMAIL_USERNAME: ${{ secrets.GMAIL_USERNAME }}
          GMAIL_APP_PASSWORD: ${{ secrets.GMAIL_APP_PASSWORD }}
          BASE_URL: ${{ secrets.BASE_URL }}
          FRONT_URL: ${{ secrets.FRONT_URL }}
          SOLAPI_KEY: ${{ secrets.SOLAPI_KEY }}
          SOLAPI_SECRET: ${{ secrets.SOLAPI_SECRET }}
          SOLAPI_FROM_NUMBER: ${{ secrets.SOLAPI_FROM_NUMBER }}
        with:
          host: ${{ secrets.EC2_HOST_API }}
          username: ec2-user
          key: ${{ secrets.EC2_SSH_KEY }}
          envs: RDS_ENDPOINT,RDS_USERNAME,RDS_PASSWORD,REDIS_HOST,REDIS_PORT,KAFKA_BOOTSTRAP_SERVERS,KAFKA_API_KEY,KAFKA_API_SECRET,JWT_SECRET,GMS_SECRET,GMS_BASE_URL,GOOGLE_CLIENT_ID,GOOGLE_CLIENT_SECRET,GOOGLE_REDIRECT_URI,GMAIL_USERNAME,GMAIL_APP_PASSWORD,BASE_URL,FRONT_URL,SOLAPI_KEY,SOLAPI_SECRET,SOLAPI_FROM_NUMBER
          script: |
            aws ecr get-login-password --region ${{ env.AWS_REGION }} | docker login --username AWS --password-stdin ${{ steps.login-ecr.outputs.registry }}

            # 1. 현재 실행 중인 컨테이너 이미지 ID 저장 (롤백용)
            CURRENT_IMAGE_ID=$(docker inspect --format='{{.Image}}' api-server 2>/dev/null || true)
            echo "Current Image ID: $CURRENT_IMAGE_ID"

            # 2. 새 이미지 Pull
            docker pull ${{ steps.login-ecr.outputs.registry }}/${{ env.ECR_REPOSITORY_API }}:latest

            # 3. 기존 컨테이너 중지 및 삭제
            docker stop api-server || true
            docker rm api-server || true

            # 로그 디렉토리 생성
            mkdir -p /home/ec2-user/logs/api-server

            # 4. 새 컨테이너 실행
            echo "Starting new container..."
            docker run -d --name api-server \
              -e TZ=Asia/Seoul \
              -p 8080:8080 \
              -v /home/ec2-user/logs/api-server:/var/log/newstagram \
              -e LOGGING_FILE_NAME=/var/log/newstagram/application.log \
              -e SPRING_PROFILES_ACTIVE=prod \
              -e RDS_ENDPOINT="$RDS_ENDPOINT" \
              -e RDS_USERNAME="$RDS_USERNAME" \
              -e RDS_PASSWORD="$RDS_PASSWORD" \
              -e REDIS_HOST="$REDIS_HOST" \
              -e REDIS_PORT="$REDIS_PORT" \
              -e KAFKA_BOOTSTRAP_SERVERS="$KAFKA_BOOTSTRAP_SERVERS" \
              -e KAFKA_API_KEY="$KAFKA_API_KEY" \
              -e KAFKA_API_SECRET="$KAFKA_API_SECRET" \
              -e JWT_SECRET="$JWT_SECRET" \
              -e GMS_SECRET="$GMS_SECRET" \
              -e GMS_BASE_URL="$GMS_BASE_URL" \
              -e GOOGLE_CLIENT_ID="$GOOGLE_CLIENT_ID" \
              -e GOOGLE_CLIENT_SECRET="$GOOGLE_CLIENT_SECRET" \
              -e GOOGLE_REDIRECT_URI="$GOOGLE_REDIRECT_URI" \
              -e GMAIL_USERNAME="$GMAIL_USERNAME" \
              -e GMAIL_APP_PASSWORD="$GMAIL_APP_PASSWORD" \
              -e BASE_URL="$BASE_URL" \
              -e FRONT_URL="$FRONT_URL" \
              -e SOLAPI_KEY="$SOLAPI_KEY" \
              -e SOLAPI_SECRET="$SOLAPI_SECRET" \
              -e SOLAPI_FROM_NUMBER="$SOLAPI_FROM_NUMBER" \
              ${{ steps.login-ecr.outputs.registry }}/${{ env.ECR_REPOSITORY_API }}:latest

            # 5. 헬스 체크 및 롤백
            echo "Health checking..."
            sleep 15
            if [ -z "$(docker ps -q -f name=api-server)" ]; then
              echo "Deployment failed! Container is not running."
              docker logs api-server
              
              echo "Rolling back to previous version..."
              docker rm api-server || true
              
              if [ -n "$CURRENT_IMAGE_ID" ]; then
                docker run -d --name api-server \
                  -e TZ=Asia/Seoul \
                  -p 8080:8080 \
                  -v /home/ec2-user/logs/api-server:/var/log/newstagram \
                  -e LOGGING_FILE_NAME=/var/log/newstagram/application.log \
                  -e SPRING_PROFILES_ACTIVE=prod \
                  -e RDS_ENDPOINT="$RDS_ENDPOINT" \
                  -e RDS_USERNAME="$RDS_USERNAME" \
                  -e RDS_PASSWORD="$RDS_PASSWORD" \
                  -e REDIS_HOST="$REDIS_HOST" \
                  -e REDIS_PORT="$REDIS_PORT" \
                  -e KAFKA_BOOTSTRAP_SERVERS="$KAFKA_BOOTSTRAP_SERVERS" \
                  -e KAFKA_API_KEY="$KAFKA_API_KEY" \
                  -e KAFKA_API_SECRET="$KAFKA_API_SECRET" \
                  -e JWT_SECRET="$JWT_SECRET" \
                  -e GMS_SECRET="$GMS_SECRET" \
                  -e GMS_BASE_URL="$GMS_BASE_URL" \
                  -e GOOGLE_CLIENT_ID="$GOOGLE_CLIENT_ID" \
                  -e GOOGLE_CLIENT_SECRET="$GOOGLE_CLIENT_SECRET" \
                  -e GOOGLE_REDIRECT_URI="$GOOGLE_REDIRECT_URI" \
                  -e GMAIL_USERNAME="$GMAIL_USERNAME" \
                  -e GMAIL_APP_PASSWORD="$GMAIL_APP_PASSWORD" \
                  -e BASE_URL="$BASE_URL" \
                  -e SOLAPI_KEY="$SOLAPI_KEY" \
                  -e SOLAPI_SECRET="$SOLAPI_SECRET" \
                  -e SOLAPI_FROM_NUMBER="$SOLAPI_FROM_NUMBER" \
                  $CURRENT_IMAGE_ID
                echo "Rollback successful."
              else
                echo "No previous image found. Cannot rollback."
              fi
              exit 1
            else
              echo "Deployment successful."
              # 6. 미사용 이미지 정리 (Dangling images)
              docker image prune -f
            fi

  # 4. CD: Logging Server 배포
  deploy-logging-server:
    needs: ci
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          java-version: "17"
          distribution: "temurin"

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Login to Amazon ECR
        id: login-ecr
        uses: aws-actions/amazon-ecr-login@v2

      - name: Build and Push Docker Image
        env:
          ECR_REGISTRY: ${{ steps.login-ecr.outputs.registry }}
          IMAGE_TAG: ${{ github.sha }}
        run: |
          chmod +x gradlew
          ./gradlew :logging-server:bootJar -x test
          docker build -t $ECR_REGISTRY/$ECR_REPOSITORY_LOG:latest -f logging-server/Dockerfile .
          docker push $ECR_REGISTRY/$ECR_REPOSITORY_LOG:latest

      - name: Deploy to EC2 (Logging Server)
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.EC2_HOST_LOG }}
          username: ec2-user
          key: ${{ secrets.EC2_SSH_KEY }}
          script: |
            aws ecr get-login-password --region ${{ env.AWS_REGION }} | docker login --username AWS --password-stdin ${{ steps.login-ecr.outputs.registry }}

            # 1. 현재 실행 중인 컨테이너 이미지 ID 저장 (롤백용)
            CURRENT_IMAGE_ID=$(docker inspect --format='{{.Image}}' logging-server 2>/dev/null || true)
            echo "Current Image ID: $CURRENT_IMAGE_ID"

            # 2. 새 이미지 Pull
            docker pull ${{ steps.login-ecr.outputs.registry }}/${{ env.ECR_REPOSITORY_LOG }}:latest

            # 3. 기존 컨테이너 중지 및 삭제
            docker stop logging-server || true
            docker rm logging-server || true

            # 로그 디렉토리 생성
            mkdir -p /home/ec2-user/logs/logging-server

            # 4. 새 컨테이너 실행
            echo "Starting new container..."
            docker run -d --name logging-server \
              -e TZ=Asia/Seoul \
              -p 8081:8081 \
              -v /home/ec2-user/logs/logging-server:/var/log/newstagram \
              -e LOGGING_FILE_NAME=/var/log/newstagram/application.log \
              -e SPRING_PROFILES_ACTIVE=prod \
              -e RDS_ENDPOINT="${{ secrets.RDS_ENDPOINT }}" \
              -e RDS_USERNAME="${{ secrets.RDS_USERNAME }}" \
              -e RDS_PASSWORD="${{ secrets.RDS_PASSWORD }}" \
              -e REDIS_HOST="${{ secrets.REDIS_HOST }}" \
              -e REDIS_PORT="${{ secrets.REDIS_PORT }}" \
              -e KAFKA_BOOTSTRAP_SERVERS="${{ secrets.KAFKA_BOOTSTRAP_SERVERS }}" \
              -e KAFKA_API_KEY="${{ secrets.KAFKA_API_KEY }}" \
              -e KAFKA_API_SECRET="${{ secrets.KAFKA_API_SECRET }}" \
              -e GMS_SECRET="${{ secrets.GMS_SECRET }}" \
              -e GMS_BASE_URL="${{ secrets.GMS_BASE_URL }}" \
              ${{ steps.login-ecr.outputs.registry }}/${{ env.ECR_REPOSITORY_LOG }}:latest

            # 5. 헬스 체크 및 롤백
            echo "Health checking..."
            sleep 15
            if [ -z "$(docker ps -q -f name=logging-server)" ]; then
              echo "Deployment failed! Container is not running."
              docker logs logging-server
              
              echo "Rolling back to previous version..."
              docker rm logging-server || true
              
              if [ -n "$CURRENT_IMAGE_ID" ]; then
                docker run -d --name logging-server \
                  -e TZ=Asia/Seoul \
                  -p 8081:8081 \
                  -v /home/ec2-user/logs/logging-server:/var/log/newstagram \
                  -e LOGGING_FILE_NAME=/var/log/newstagram/application.log \
                  -e SPRING_PROFILES_ACTIVE=prod \
                  -e RDS_ENDPOINT="${{ secrets.RDS_ENDPOINT }}" \
                  -e RDS_USERNAME="${{ secrets.RDS_USERNAME }}" \
                  -e RDS_PASSWORD="${{ secrets.RDS_PASSWORD }}" \
                  -e REDIS_HOST="${{ secrets.REDIS_HOST }}" \
                  -e REDIS_PORT="${{ secrets.REDIS_PORT }}" \
                  -e KAFKA_BOOTSTRAP_SERVERS="${{ secrets.KAFKA_BOOTSTRAP_SERVERS }}" \
                  -e KAFKA_API_KEY="${{ secrets.KAFKA_API_KEY }}" \
                  -e KAFKA_API_SECRET="${{ secrets.KAFKA_API_SECRET }}" \
                  -e GMS_SECRET="${{ secrets.GMS_SECRET }}" \
                  -e GMS_BASE_URL="${{ secrets.GMS_BASE_URL }}" \
                  $CURRENT_IMAGE_ID
                echo "Rollback successful."
              else
                echo "No previous image found. Cannot rollback."
              fi
              exit 1
            else
              echo "Deployment successful."
              # 6. 미사용 이미지 정리 (Dangling images)
              docker image prune -f
            fi
